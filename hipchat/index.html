<html>
<meta http-equiv="Cache-Control" content="no-store" />
<head>
  <title>Hipchat Connector</title>
  <script src="https://connectors.tableau.com/libs/tableauwdc-2.0.0-beta.js" type="text/javascript"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js" type="text/javascript"></script>
  <script type="text/javascript">
    (function() {
      var roomsdone;
      var dataToReturn = [];
      var rooms;
      var myConnector = tableau.makeConnector();
      init = function() {
        tableau.initCallback();
      };

      myConnector.getSchema = function(schemacallback) {
        tableau.log('creating schema');

        var cols = [
            { id : "room", alias : "Room Name", dataType : tableau.dataTypeEnum.string },
            { id : "time", alias : "Timestamp", dataType : tableau.dataTypeEnum.datetime },
            { id : "senderID", alias : "Sender ID", dataType : tableau.dataTypeEnum.string },
            { id : "alias", alias : "Sender Alias", dataType : tableau.dataTypeEnum.string },
            { id : "name", alias : "Sender Name", dataType : tableau.dataTypeEnum.string },
            { id : "msgID", alias : "Message ID", dataType : tableau.dataTypeEnum.string },
            { id : "text", alias : "Message", dataType : tableau.dataTypeEnum.string }
        ];

        var tableInfo = {
            id : "messages",
            alias : "Last 1000 messages for each selected Hipchat room",
            columns : cols
        };

        schemacallback([tableInfo]);
      };

      /*myConnector.getColumnHeaders = function() {
          var fieldNames = [ 'Room'
                           , 'Timestamp'
                           , 'From_ID'
                           , 'From_Alias'
                           , 'From_Name'
                           , 'Message ID'
                           , 'Text'];
          var fieldTypes = [ 'string'
                           , 'string'
                           , 'string'
                           , 'string'
                           , 'string'
                           , 'string'
                           , 'string'];

          tableau.headersCallback(fieldNames, fieldTypes);
      }*/

      myConnector.getData = function(table, doneCallback) {
        tableau.log(tableau.phase);
        //var lastRecordToken = (lastRecordToken) ? lastRecordToken : 0;
        //tableau.log('last record: ' + lastRecordToken);
        var hasMoreData = false;

        tableau.log(data);
        var data = JSON.parse(tableau.connectionData);

        if (!data) {
          tableau.log('Error: ' + data)
          tableau.abortWithError("Hipchat Connection requires Authentication Code and at least one Room" + data);
        }
        rooms = data.rooms;
        tableau.log(rooms);
        roomsdone = 0;
        //tableau.log(now.toDateString());
        tableau.log('looping ' + rooms.length + ' times.')
        for (var i = 0; i < rooms.length; i++) {
          var room = rooms[i];
          var roomname = data.roomnames[i];
          getMessages(table, room, roomname, data.auth, 0, doneCallback);
        }        
      };

      /*myConnector.getTableData = function(lastRecordToken) {
        //tableau.log(tableau.phase);
        var lastRecordToken = (lastRecordToken) ? lastRecordToken : 0;
        tableau.log('last record: ' + lastRecordToken);
        var hasMoreData = false;

        tableau.log(data);
        var data = JSON.parse(tableau.connectionData);

        if (!data) {
          tableau.log('Error: ' + data)
          tableau.abortWithError("Hipchat Connection requires Authentication Code and at least one Room" + data);
        }
        rooms = data.rooms;
        tableau.log(rooms);
        roomsdone = 0;
        //tableau.log(now.toDateString());
        tableau.log('looping ' + rooms.length + ' times.')
        for (var i = 0; i < rooms.length; i++) {
          var room = rooms[i];
          var roomname = data.roomnames[i];
          getMessages(room, roomname, data.auth, lastRecordToken);
        }        
        
      }*/

      tableau.registerConnector(myConnector);
  
      function getMessages(table, room, roomname, auth, index, doneCallback) {
        var now = new Date(Date.now());
        var url = "https://api.hipchat.com/v2/room/" + room +"/history";
        url += '?auth_token=' + auth;
        url += '&max-results=1000'; 
        url += '&reverse=false';
        url += '&start-index=' + index;
        url += '&timezone=' + 'America/Los_Angeles'
        url += '&date=' + (now.getMonth()+1).toString() + "%20" + now.getDate().toString() + "%20" + now.getFullYear().toString();

        tableau.log('Pulling data for: ' + room + ' : ' + url);
        var xhr = $.ajax({
          url: url,
          dataType: 'json',
          context: roomname,
          success: function (response) {
            var roomname = this;
            tableau.log('data returned for room: ' + roomname);
            if (response.items) {
              console.log(response.links);
              for (var j =0; j < response.items.length; j++) {
                //console.log(roomname);
                var row = response.items[j];
                var bot = row.from == 'Karma' || row.from == 'Sassy' || row.from == 'Fogbugzlinker Bot';
                var newRow = { 'room' : roomname.toString()
                             , 'time' : row.date
                             , 'senderID' : (bot) ? row.from : row.from.id
                             , 'alias' : (bot) ? row.from : row.from.mention_name
                             , 'name' : (bot) ? row.from : row.from.name
                             , 'msgID' : row.id
                             , 'text' : row.message };
                //console.log(JSON.stringify(newRow));
                //tableau.log(newRow);
                dataToReturn.push(newRow);                          
              }
              var hasMoreData = !!hasMoreData || !!response.links.next
              console.log('more data? ' + hasMoreData);
              if (hasMoreData) {
                index += 1000;
                getMessages(room, roomname, auth, index);
              } else {
                roomsdone++;
                if (roomsdone == rooms.length) {
                  table.appendRows(dataToReturn);
                  doneCallback();
                }
              }
            } else {
              tableau.abortWithError("No results found.");
            }
          }, 
          error: function (xhr, ajaxOptions, thrownError) {
              tableau.log("Connection error: " + xhr.responseText + "\n" + thrownError);
              tableau.abortWithError("Error while trying to connect to the hipchat api data source." + xhr.responseText + "\n" + thrownError);
          }
        });
      }
      var layout = function() {
        console.log('adding alpha containers');
        $('#submit').before($('<div>').attr({'id':'other'}).append($('<h2>').html('#')));
        for (var i=0;i<26;i++) {
          var letter = String.fromCharCode(97 + i);
          var alpha_container = $('<div>').attr({'id':letter});
          alpha_container.append($('<h2>').html(letter.toUpperCase()));
          $('#submit').before(alpha_container);
        }
      };
      function addRooms(url) {    
        var auth = $('#auth').val();
        $.ajax({
          url: url,
          dataType: 'json',
          success: function (response) {
              tableau.log(response);
              for (var i = 0; i < response.items.length; i++) {
                  var room = response.items[i];
                  var letter = room.name.charAt(0).toLowerCase();
                  //tableau.log(letter);
                  var containerid = (letter.charCodeAt(0) > 96 && letter.charCodeAt(0) < 97 + 26) ? "#" + letter : '#other';
                  var input = $('<label>').html(room.name).prepend($('<input>').attr({'type':'checkbox', 'id': room.id, 'value': room.id}));
                  $(containerid).append(input);
                  //$('#submit').before(input);
              }
              $('#auth-input').hide();
              $('#room-list').show();

              if (response.links.next)
                addRooms(response.links.next + '&auth_token=' + auth);
          },
          error: function (xhr, ajaxOptions, thrownError) {
              tableau.log("Connection error: " + xhr.responseText + "\n" + thrownError);
              tableau.abortWithError("Error while trying to connect to the hipchat api data source." + xhr.responseText + "\n" + thrownError);
          }
        });
      }

      $(document).ready(function() {
          layout();
          $('#search').change(function(e) {
            var term = $('#search').val().toLowerCase();
            tableau.log('searching for room: ' + term);
            $('fieldset label').each(function(index, element) {
              var ele = $(element);
              if (ele.text().toLowerCase().search(term) < 0) {
                ele.addClass('hidden')
              } else {
                ele.removeClass('hidden');
              }
            });
            $('fieldset div').each(function(index, element) {
              console.log('looping through divs');
              var ele = $(element);
              console.log()
              if (ele.children('label.hidden').length === ele.children('label').length) {
                ele.addClass('hidden');
              } else {
                ele.removeClass('hidden');
              }
            });
          });
          $('#next').click(function() {
              var auth = $('#auth').val();
              addRooms("http://api.hipchat.com/v2/room?max-results=1000&auth_token=" + auth);
          });
          $('#submit').click(function() {
              tableau.log('click!')
              var auth = $('#auth').val();
              var rooms = [];
              var roomnames = [];
              $('#room-list input').each(function(index, element) {
                  var ele = $(element);
                  if (ele.prop('checked')) {
                      tableau.log('element checked: ' + ele);
                      rooms.push(ele.val());
                      roomnames.push(ele.parent().text());
                  }
              });   
              tableau.connectionName = "Hipchat History"
              tableau.connectionData = JSON.stringify({'auth' : auth, 'rooms' : rooms, 'roomnames':roomnames});
              //tableau.log(tableau.connectionData);
              tableau.submit();
          });
      });
    })();
  </script>  
  <style type="text/css">
    fieldset label {
      display:inline-block;
      margin:.25em;
    }
    .hidden {
      display:none;
    }
  </style>
</head>
<body>  
  <div id='auth-input'>
    <label>Authorization Code</label>
    <input id='auth' type='text' value=''/>
    <button type="button" id="next">Next</button>
  </div>
  <fieldset id="room-list" style="display:none;">
    <Legend>Rooms</Legend>
    <label for="search">Room Name Search:</label>
    <input type="text" id="search">
    <!-- Room checkboxes go here -->
    <button type="button" id="submit">Go</button>
  </fieldset>
</body>
</html>